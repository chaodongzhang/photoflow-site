# 📘 PhotoFlow — PRD v1.0（执行版）
**发布日期**：2025-10-14  
**目标平台**：macOS 14+（Apple Silicon 优先）  
**工具链**：Xcode 16.4 · Swift 5.10+ · Core Image / Metal 准备  

---

## 1. 产品愿景
PhotoFlow 是一个基于节点图（Node Graph）的非破坏性图像编辑应用。  
目标是在 Apple Silicon 上提供一个**快速、稳定、可扩展**的桌面修图流程，
以“模块化节点”形式实现图像处理、预览与导出。

---

## 2. 版本目标
| 项目 | 内容 |
|------|------|
| **版本号** | v1.0（重建版） |
| **开发周期** | 8 个月 |
| **目标** | 建立完整的节点编辑闭环与 Core Image 渲染管线 |
| **非目标** | AI、插件系统、Metal 后端（规划中） |

---

## 3. 功能范围（MoSCoW）

### Must（v1.0 必须）
- **节点系统**：创建、删除、连接、重命名、禁用。
- **基础节点集**：`Read`、`Write`、`Transform`、`ColorCorrect`、`Merge`、`Blur`、`Exposure`、`WhiteBalance`。
- **参数编辑器**：支持滑条、输入框、开关；参数改动实时更新预览。
- **预览器**：实时显示渲染结果；支持 Fit / 1:1 / 缩放 / 平移。
- **项目管理**：保存、加载、版本字段、自动备份。
- **撤销与重做**：基于操作栈的 Undo/Redo。
- **性能监测**：在界面右上角显示渲染时间与内存占用。

### Should（v1.1 可扩展）
- 节点组模板与参数联动。
- LUT、曲线节点（独立 UI 组件）。
- 导出格式：PNG / TIFF / JPEG。
- 快捷键映射。

### Could（v1.2+）
- Metal 后端（自定义核支持）。
- AI / ML 节点。

### Won’t
- 云同步 / 协作。
- 移动端版本。

---

## 4. 用户故事
1. 用户从节点库拖拽 `Read` 节点导入图片。
2. 用户将节点连接并调整参数，实时查看预览。
3. 用户保存项目，稍后可重新加载并继续编辑。
4. 用户使用 `Write` 节点导出结果图像。

---

## 5. 技术实现约束
| 项目 | 约束 |
|------|------|
| 渲染后端 | Core Image (CIFilter + CIContext) |
| 数据结构 | Codable NodeGraph + Edge |
| 文件格式 | `.pflow` (JSON) |
| 渲染线程 | GCD 后台队列 |
| 颜色空间 | 线性 sRGB |
| 语言与框架 | Swift / SwiftUI |
| 文件访问 | 沙盒 + DocumentPicker |

---

## 6. 性能目标 (SLO)
| 项目 | 目标值 |
|------|--------|
| 首帧可交互 | ≤ 1.5 秒 |
| 参数修改到预览更新 | ≤ 250 ms (P95) |
| 内存上限 | ≤ 4 GB |
| 稳定性 | Crash-Free ≥ 99.9% |

---

## 7. 验收标准 (DoD)
| 模块 | 验收条件 |
|------|-----------|
| NodeGraph | 节点操作正确；保存/加载一致性 100% |
| CIRenderer | 可执行完整节点链渲染；结果正确 |
| Viewer | 预览实时更新且稳定 |
| Inspector | 参数绑定正确、无 UI 延迟 |
| Undo/Redo | 操作栈回退与前进均正确 |
| 项目保存 | 文件可加载且包含版本字段 |
| 性能 | 预览响应 ≤ 250ms；稳定运行 200 次操作 |

---

## 8. 开发阶段规划
| 阶段 | 目标 | 时间 |
|------|------|------|
| Sprint 1 | NodeGraph + 文件结构 | 2 周 |
| Sprint 2 | Canvas + 拖拽 + 连接 | 2 周 |
| Sprint 3 | 参数绑定 + 预览器 | 2 周 |
| Sprint 4 | 渲染闭环与导出 | 2 周 |
| Sprint 5 | 稳定性与性能优化 | 2 周 |
| Sprint 6 | 文档 + 内测发布 | 2 周 |

---

## 9. 交付标准
- 可运行 macOS 应用。
- 支持节点编辑与实时预览。
- CI 编译与测试通过。
- 性能与稳定性达到 SLO。

---

## 10. 附录：目录建议
```
PhotoFlow/
 ├── Sources/
 │   ├── Core/          # NodeGraph / CIRenderer
 │   ├── UI/            # SwiftUI 界面
 │   ├── Models/
 │   ├── IO/
 │   └── Utils/
 ├── Tests/
 └── Docs/
     ├── PRD_v1.0.md
     └── ARCHITECTURE_v1.0.md
```